## What the scripts do and why they exist
You can read through the scripts to get an idea of what they do, but below are detailed explanations of their actions. The need for the scripts is due to Termux being based on bionic instead of glibc. You can install glibc in Termux, but the install location is not FHS compliant (read more [here](https://wiki.termux.com/wiki/Differences_from_Linux#Termux_uses_Bionic_libc) and [here](https://github.com/termux/termux-packages/wiki/Common-porting-problems)). Moreover, Termux applications cease to function if you attempt to change the `LD_LIBRARY_PATH` to that of glibc's location. Even though [ESPHome](https://esphome.io/) correctly identifies and compiles its binaries against bionic, the individual [PlatformIO](https://platformio.org/) toolchains do not. Therefore, the scripts create an environment where the toolchain binaries can be patched using [grun](https://github.com/termux-pacman/glibc-packages/wiki/About-glibc-runner-(grun)).
### setup_env.sh (to be ran at each new instance)
  - The setup script is very simple at its core. This script loops through key directories, where the toolchain binaries used during compiling are located, and patches each executable using grun. The mime type is checked in the `exec_grun` function so that only binary executables are patched.
  - You can skip looping the directories if you know all required binaries for a successful compilation have already been configured (e.g. from a previous run). To do so, use `source ~/setup_env.sh --no-configure` or `source ~/setup_env.sh -nc` when invoking the script. While it adds a little extra time initially, I'd recommend to always loop the directories to be certain all binaries are properly configured. These are the only options the script has. Others will be ignored.
  - The script also changes directory to `~/.esphome/configs`, activates the virtual environment, and unsets the `LD_PRELOAD` environment variable.
### install.sh (to be ran once)
  - The install script will first upgrade system packages, then install `python`, `rust`, `git`, `glibc-repo`, `file`, `libisl-glibc`, `libiconv-glibc`, and `libjpeg-turbo`. You will be prompted to choose a Termux repo. You may also be prompted to overwrite files with the package maintainer's default version. It is safe to answer _yes_ to these if you have not made any Termux customizations. Otherwise, the choice is yours.
  - The install script will then create a virtual environment at `~/.esphome` and proceed to install ESPHome. Once ESPHome is installed, the script will create two yaml files in a temporary directory; `esp8266.yaml` and `bk7231n.yaml`. These two configuration files will then attempt to be compiled. Ignore any errors you see from PlatformIO's compilation attempts. The attempts are made to facilitate the download of PlatformIO toolchains. The two configuration files will be deleted when you exit the Termux session.
  - Lastly, the setup script will be created in your home directory and then invoked. You will be returned to the prompt with the virtual environment already activated and the directory changed to `~/.esphome/configs` when the setup script completes. You should place your configuration files here before compiling for any devices.
## General usage
  - Install [Termux](https://github.com/termux/termux-app) on an Android device (e.g. Samsung Galaxy S23)
  - Open Termux
  - Issue `source <(curl -fsSL https://raw.githubusercontent.com/netman74501/termux-esphome-config/refs/heads/main/install.sh)` at the Termux prompt to install dependencies and setup the toolchain environment.
  - If everything went well, you will be in ESPHome's virtual environment when the install script has finshed. At this point the virtual environment has been installed and you can use normal ESPHome commands such as `esphome compile light_switch.yaml`.
  - Add your specific ESPHome yaml configuration files to `~/.esphome/configs`. **Please note that I have only tested and used the esp8266 and bk7231n platforms. Other may require a refractor of the scripts.**
  - You will need to run `source ~/setup_env.sh` each time you open Termux or exit the virtual environment before you can successfully compile for ESPHome. You may need to re-run the script if there are any extra dependencies that are installed through PlatformIO due to adding new sections\features to your configuration files.
## Other possible solutions and what I have tried
  - I first tried a QEMU virtual machine with Debian and a virtual x86_64 processor. This worked splendidly aside from the abysmal speed. What takes 35 seconds to compile natively took 25 minutes inside the virtual machine. I tried other processor combinations, but none provided better performance.
  - I considered using a Docker image, but found that would require [installing a virtual machine via QEMU](https://github.com/cyberkernelofficial/docker-in-termux). I actually followed part of these steps to create my Debian-based virtual machine. So, I dismissed this option altogether due to being biased from the previous QEMU attempt.
  - Proot-Distro with various architecture combinations for Alpine, Deepin, Ubuntu, and Debian failed to function correctly. Ubuntu wouldn't even give any output when started, but the others all had issues in one way or another that I could not resolve. Additionally, anything other than the `aarch64` achitecture seems to require QEMU -- which as stated before, I am biased against. Debian worked perfectly to install ESPHome, but then PlatformIO still had the same issues as bare-metal Termux. Somehow it was still trying to link to Termux's bionic instead of glibc.
  - Eventually, I tried playing with the `LD_PRELOAD` and `LD_LIBRARY_PATH` environment variables. I also looked for ways to tell PlatformIO where to find the glibc libraries or to compile against a different location. I tried adding [`platformio_options`](https://esphome.io/components/esphome/#platformio_options) to the yaml configuration (to include [`lib_extra_dirs`](https://docs.platformio.org/en/latest/projectconf/sections/env/options/library/lib_ldf_mode.html) and [`lib_ldf_mode`](https://docs.platformio.org/en/latest/projectconf/sections/env/options/library/lib_ldf_mode.html)), but these methods all lead to fruitless endevours.
  - `grun --shell`. Technically, each binary only needs to be configured once. The configuration is remembered across Termux sessions. So, this works as long as you have already configured the binaries using grun, but not otherwise. It has the same effect as unsetting `LD_PRELOAD` and configuring the binaries before invoking the virtual environment (what the setup script does).
  - A manual install of the toolchains as described [here](https://gist.github.com/Jobians/b271a5f71f123c87b32269b18f78d827) failed as well.
  - Someone managed to compile the esp8266 toolchain [here](https://github.com/platformio/platform-espressif8266/issues/141). I did not attempt this as I don't want to have to compile every time there is an update to the toolchain.
